# ============================================
# RENDEREXPO AI STUDIO - GPU Dockerfile
# SD3.5 Runtime (RunPod)
# ============================================

FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# -------------------------------------------------
# 1) System packages
# -------------------------------------------------
RUN apt-get update && apt-get install -y \
    git wget curl nano python3 python3-pip python3-venv \
    libgl1 libglib2.0-0 libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------
# 2) Workdir
# -------------------------------------------------
WORKDIR /workspace

# -------------------------------------------------
# 3) Copy project
# -------------------------------------------------
COPY . /workspace

# -------------------------------------------------
# 4) Install Python deps (including Torch)
# -------------------------------------------------
RUN pip3 install --upgrade pip

# Install CUDA-enabled PyTorch
RUN pip3 install torch --index-url https://download.pytorch.org/whl/cu121

# Install main requirements
RUN pip3 install -r requirements.txt

# Install SD3.5 compatible diffusers
RUN pip3 install "diffusers>=0.32.0" transformers accelerate safetensors

# -------------------------------------------------
# 5) Expose API Port
# -------------------------------------------------
EXPOSE 8000

# -------------------------------------------------
# 6) Start SD3.5 GPU API server
# -------------------------------------------------
CMD ["uvicorn", "app.gpu_entry:app", "--host", "0.0.0.0", "--port", "8000"]
